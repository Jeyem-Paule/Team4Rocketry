#include <Wire.h>
#include <Adafruit_BMP280.h>
#include <SPI.h>
#include <SD.h>

#define SD_CS 5 // Chip select for SD card
#define SEALEVELPRESSURE_HPA (1013.25) // Standard sea-level pressure

Adafruit_BMP280 bmp; // I2C
File dataFile;

unsigned long startMillis;

void setup() {
  Serial.begin(115200);
  delay(1000);

  startMillis = millis(); // Start the timer

  // Initialize BMP280
  if (!bmp.begin(0x76)) {
    Serial.println("Could not find a valid BMP280 sensor, check wiring!");
    while (1);
  }
  Serial.println("BMP280 initialized.");

  // Initialize SD card
  if (!SD.begin(SD_CS)) {
    Serial.println("SD card initialization failed!");
    while (1);
  }
  Serial.println("SD card initialized.");

  // Create/Open file and write header
  dataFile = SD.open("/SD_Card.txt", FILE_WRITE);
  if (dataFile) {
    dataFile.println("Temperature (C), Pressure (hPa), Altitude (m), Time (s)");
    dataFile.close();
    Serial.println("Header written to SD_Card.txt");
  } else {
    Serial.println("Failed to open SD_Card.txt for writing.");
  }
}

void loop() {
  float temp = bmp.readTemperature();
  float pressure = bmp.readPressure() / 100.0; // Convert to hPa
  float altitude = bmp.readAltitude(SEALEVELPRESSURE_HPA);
  
  // Calculate elapsed time
  float elapsedTime = (millis() - startMillis) / 1000.0;

  // Open file to append data
  dataFile = SD.open("/SD_Card.txt", FILE_APPEND);
  if (dataFile) {
    dataFile.print(temp);
    dataFile.print(", ");
    dataFile.print(pressure);
    dataFile.print(", ");
    dataFile.print(altitude);
    dataFile.print(", ");
    dataFile.println(elapsedTime);

    dataFile.close();

    Serial.println("Data written: ");
    Serial.print("T = "); Serial.print(temp);
    Serial.print(" Â°C, P = "); Serial.print(pressure);
    Serial.print(" hPa, Alt = "); Serial.print(altitude);
    Serial.print(" m, Time = ");
    Serial.print(elapsedTime);
    Serial.println(" s");
  } else {
    Serial.println("Error opening SD_Card.txt");
  }

  delay(500); // Log every 0.5 seconds
}
